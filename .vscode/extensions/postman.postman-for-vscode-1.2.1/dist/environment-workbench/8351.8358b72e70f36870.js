"use strict";(self.webpackChunkenvironment_workbench=self.webpackChunkenvironment_workbench||[]).push([[8351],{21278:(e,t,s)=>{s.d(t,{Z:()=>M});var i=s(40540),n=s(50297),r=s(58560),a=s(74962),o=s(63622),l=s(59530),u=s.n(l),d=s(98283),c=s(19956),h=s(80809);const p="environment-variables-editor-paint-time",m="environment-variables-editor-paint-mark";var v=s(52322);const b=["entityType","isEditable","bleed","onChange","values"],{PerformanceMarkPaint:f}=h.perfComponents,g=()=>{performance.measure(p,{},m),(0,h.sendMeasureEvent)({name:p})},y=u().div.withConfig({displayName:"variable-editor__StyledVariablesEditor",componentId:"sc-fu3kt9-0"})(["height:100%;padding:0 var(--spacing-l);flex:1;min-height:0;"]),w=function(e){const{entityType:t="environment",isEditable:s=!0,bleed:n=!1,onChange:r,values:a}=e,o=(0,d.Z)(e,b),[l,u]=(0,i.useState)([]);return(0,i.useMemo)((()=>{const e=new Set([]),t=((e,t)=>(s,i,n)=>{var r,a;let o=-1;return(null==(r=e[n])?void 0:r.key)===s&&(o=n),(null==(a=e[n])?void 0:a.value)===i&&(o=n),-1===o&&(o=e.findIndex(((e,i)=>e.key===s&&!t.has(i)))),-1===o&&(o=e.findIndex(((e,s)=>e.value===i&&!t.has(s)))),-1!==o?(t.add(o),e[o]):null})(l,e),s=a.map(((e,s)=>{var i,n;return{key:e.key,value:e.value,isMasked:"secret"===e.type&&(null==(i=null==(n=t(e.key,e.value,s))?void 0:n.isMasked)||i)}}));u(s)}),[a]),(0,v.jsx)(y,{children:(0,v.jsx)(f,{markName:m,callback:g,children:(0,v.jsx)(c.KeyValueEditor,Object.assign({tableName:`Variables Editor - ${t}`,entityType:t,keyHeading:"Variable",valueHeading:"Initial value",sessionHeading:"Current value",keyPlaceholder:"Add new variable",valuePlaceholder:"",values:a,onChange:e=>{r(e)},showColumns:["key","variableType","value","sessionValue"],allowedColumns:["key","variableType","value","sessionValue"],containment:{bleed:n},nonEditableKeys:!s,nonEditableValues:!s,nonEditableToggles:!s,nonEditableVariableTypes:!s,disableCreate:!s,disableDelete:!s,disableVariablePersistAction:!s,maskStatesMap:l,toggleMaskValue:e=>{const t=l[e],s=[...l];s[e]=Object.assign({},t,{isMasked:!t.isMasked}),u(s)},initialColumnWidths:[23,14,23,40],enableFiltering:!0,enableScroll:!0,disallowDuplicates:!0},o))})})};var S=s(51925),k=s(62356),C=s(9414);const E=(0,n.observer)((()=>{const[e,t]=(0,k.Z)(),s=(0,S.Z)(),i=(0,C.Z)();return(0,v.jsx)(w,{values:e,onChange:t,isDirty:s,isEditable:i.userCanUpdate})}));var x=s(80429),j=s(24867),V=s(26663),D=s.n(V),I=s(39245),R=s(10099),O=s(34011);const A=u()(r.Z).withConfig({displayName:"request-access__RequestAccessContainer",componentId:"sc-itp9th-0"})(["padding:0 var(--spacing-xl) var(--spacing-m) 0;min-width:max-content;border-bottom:var(--border-width-default) var(--border-style-solid) var(--border-color-default);"]),U=(e,t)=>`${D().ARTEMIS_URL}/workspace/${e}/environment/${t}`,Z=()=>{const e=(0,R.useActiveWorkspaceId)(),t=(0,O.Z)();return(0,v.jsxs)(A,{alignItems:"center",justifyContent:"space-between",children:[(0,v.jsxs)(r.Z,{padding:"spacing-zero spacing-m",gap:"spacing-s",alignItems:"center",children:[(0,v.jsx)(j.Z,{}),(0,v.jsx)(o.ZP,{type:"para",color:"content-color-secondary",children:"Request access to edit the initial values of these variables. You can edit the current value."})]}),(0,v.jsx)(I.Link,{to:U(e,t),target:"_blank",children:(0,v.jsx)(x.Z,{type:"outline",size:"medium",text:"Request Access",onClick:()=>null})})]})};var N=s(97482);const L=u()(r.Z).withConfig({displayName:"environment-variables-container__EnvironmentDescriptionContainer",componentId:"sc-1kkt6so-0"})(["margin:auto;margin-top:var(--spacing-xxxl);"]),M=(0,n.observer)((()=>{const e=(0,C.Z)(),t=(0,N.hf)().noVariablesEmptyState,[s]=(0,k.Z)();return e.userCanUpdate||0!==s.length?!e.userCanUpdate&&s.length>0?(0,v.jsxs)(v.Fragment,{children:[t.showRequestAccess&&(0,v.jsx)(Z,{}),(0,v.jsx)(E,{})]}):(0,v.jsx)(E,{}):(0,v.jsxs)(v.Fragment,{children:[t.showRequestAccess&&(0,v.jsx)(Z,{}),(0,v.jsxs)(L,{direction:"column",gap:"spacing-s",children:[(0,v.jsx)(r.Z,{alignItems:"center",justifyContent:"center",children:(0,v.jsx)(a.Z,{type:"h4",text:t.header})}),(0,v.jsx)(o.ZP,{type:"para",color:"content-color-secondary",children:t.description})]})]})}))},61601:(e,t,s)=>{s.d(t,{Z:()=>p}),s(40540);var i=s(50297),n=s(59530),r=s.n(n),a=s(63622),o=(s(39245),s(71453),s(21278)),l=s(62356),u=s(9414),d=s(94720),c=s(52322);const h=r()(a.ZP).withConfig({displayName:"globals-variables-container__Description",componentId:"sc-1r98w31-0"})(["padding:0 var(--spacing-l);"]),p=(0,i.observer)((()=>{const e=(0,u.Z)(),[t]=(0,l.Z)(),s=t.length>0||e.userCanUpdate;return(0,c.jsxs)(c.Fragment,{children:[s&&(0,c.jsxs)(h,{type:"body-medium",children:[d.Bq,!1]}),(0,c.jsx)(o.Z,{})]})}))},16464:(e,t,s)=>{s.d(t,{Z:()=>q});var i=s(40540),n=s(59530),r=s.n(n),a=s(58560),o=s(50297),l=s(39245),u=s(82196),d=s(64495),c=s(49886),h=s(97482);const p=()=>(0,h.hf)().path.map((e=>({name:e.name}))),m=()=>(0,h.hf)().name;var v=s(97201);var b=s(34011),f=s(9414);var g=s(81397),y=s(37691);var w=s(52322);const S=r().div.withConfig({displayName:"fork-label__ForkLabelWrapper",componentId:"sc-1853z6u-0"})(["cursor:default;display:flex;align-items:center;overflow:hidden;"]),k=r().p.withConfig({displayName:"fork-label__LabelContainer",componentId:"sc-1853z6u-1"})(["display:inline-block;white-space:nowrap;overflow:hidden;margin-left:var(--spacing-xs);font-size:var(--text-size-s);font-weight:var(--text-weight-regular);text-overflow:ellipsis;color:var(--content-color-tertiary);max-width:120px;"]),C=()=>{const e=(0,h.hf)().forkLabel;return e?(0,w.jsxs)(S,{children:[(0,w.jsx)(y.Z,{color:"content-color-tertiary",size:"small","data-testid":"fork-icon"}),(0,w.jsx)(g.Z,{content:e,children:(0,w.jsx)(k,{children:e})})]}):null},E=r().div.withConfig({displayName:"tab-header-left-section-with-rename__BreadcrumbContainer",componentId:"sc-1838akf-0"})(["color:var(--content-color-primary);font-weight:var(--text-weight-medium);width:100%;"]),x=r()(a.Z).withConfig({displayName:"tab-header-left-section-with-rename__LeftSectionRow",componentId:"sc-1838akf-1"})(["width:100%;padding:var(--spacing-xs);overflow:hidden;"]),j=(0,o.observer)((()=>{const e=(0,h.hf)(),t=p(),s=m(),n=(0,b.Z)(),r=(0,f.Z)(),o=(0,h.hf)().isForked,g=(0,i.useRef)(null),{rename:y}=(0,l.useAdditionalRouteContext)();(0,i.useEffect)((()=>{var e;y&&(null==(e=g.current)||null==e.triggerRenameMode||e.triggerRenameMode())}),[y]);const{mutate:S}=(()=>{const e=(0,h.hf)(),{mutate:t,isLoading:s}=(0,v.useMutation)(e.renameMutationOptions);return{mutate:t,isLoading:s}})();return(0,w.jsx)(x,{direction:"row",shrink:1,grow:0,alignItems:"center",gap:"spacing-s","data-testid":"rename-container",children:(0,w.jsx)(E,{children:(0,w.jsx)(u.aG,{ref:g,appendActions:(0,w.jsxs)(a.Z,{alignItems:"center",gap:"spacing-s",children:[o&&(0,w.jsx)(C,{}),!r.userCanUpdate&&(0,w.jsx)(c.Z,{"data-testid":"lock-icon",title:"Read only"})]}),children:t.map((t=>(0,w.jsx)(d.Z,{enableRename:Boolean(r.userCanUpdate&&e.renameMutationOptions),renameInputConfig:{value:s,placeholder:"",onSubmit:e=>{s!==e&&S({environmentId:n,name:e})}},itemData:t,children:t.name},t.name)))})})})}));var V=s(51925);const D=()=>(0,h.hf)().isConflicted,I=(0,o.observer)((()=>{const e=(0,V.Z)(),t=D(),s=m(),{setTabTitle:n}=(0,l.useTabTitleMeta)();return(0,i.useEffect)((()=>{n(s,"environment",{isDirty:e,isConflicted:t})}),[s,e,t]),(0,w.jsx)(j,{})}));var R=s(80429),O=s(24502),A=s(26246),U=s(83354);const Z=new Set(["Alt","Meta","Control","Shift"]);var N=s(64691),L=s(48263),M=s(59824),F=s(17282),P=s(29225),B=s(19578),T=s(56880),_=s(10099),G=s(98276);const Y=e=>e?"You don't have permission to take this action.":"",$=(0,o.observer)((()=>{const e=A.Modals.getModals(),t=(0,B.getTabManager)(),s=(0,l.useNavigate)(),i=(0,_.useActiveWorkspaceId)(),n=(0,b.Z)(),r=m(),a=(0,G.useEnvironmentDelete)(),o=(0,G.useEnvironmentDuplicate)(),u=(0,f.Z)(),d=[{label:"Duplicate",type:"default",isDisabled:!u.userCanCreate,tooltip:Y(!u.userCanCreate),onClick:()=>{o.mutate({environmentId:n,workspaceId:i},{onSuccess:({data:e})=>{s(`/workspace/${i}/environment/${e.owner}-${e.id}`,{},{customNavEvent:l.OPEN_EXTENSION_URL})}})}},{label:"Delete",type:u.userCanDelete?"destructive":"default",isDisabled:!u.userCanDelete,tooltip:Y(!u.userCanDelete),onClick:async()=>{const s=await e.showWarningDialog({uid:"environment-workbench-delete-confirmation",subject:`Delete "${r}"?`,message:"Deleting this environment might cause any monitors, scheduled runs or mock servers using it to stop functioning properly. Are you sure you want to continue?",options:[{title:"Cancel",isDefaultOnDismiss:!0},{title:"Delete",isPrimary:!0}]});if(s&&"Delete"===s.title)return T.AnalyticsService.addEventV2({category:"environment",action:"delete",label:"workbench"}),a.mutate({environmentId:n,workspaceId:i},{onSuccess:()=>{t.closeTabByRoute(`/workspace/${i}/environment/${n}`)}})}}];return(0,w.jsxs)(N.Z,{children:[(0,w.jsx)(L.Z,{children:(0,w.jsx)(R.Z,{"data-testid":"view-more-actions",icon:(0,w.jsx)(P.Z,{}),type:"tertiary",className:"action-menu-icon",tooltip:"View more actions"})}),(0,w.jsx)(M.Z,{placement:"bottom-end",children:d.map((e=>(0,w.jsx)(F.Z,{type:e.type,isDisabled:e.isDisabled,tooltip:e.tooltip,onClick:e.onClick,children:e.label},e.label)))})]})})),W=(0,o.observer)((()=>{const e=A.Modals.getModals(),{mutate:t,isLoading:s}=(()=>{const e=(0,h.hf)(),{mutate:t,isLoading:s}=(0,v.useMutation)(e.saveMutationOptions);return{mutate:t,isLoading:s}})(),n=(0,V.Z)(),r=D(),o=(0,b.Z)(),l=m(),u=(0,h.hf)().type,d=(0,h.hf)().isViewMoreActionsEnabled,c=async()=>{if(!r)return t();const s=await e.showWarningDialog({uid:"environment-workbench-tab-conflict-confirmation",subject:"DO YOU WANT TO SAVE?",message:`This tab ${l} has been modified from another tab. Saving these changes will overwrite the ${u}.`,options:[{title:"Cancel",isDefaultOnDismiss:!0},{title:"Save and overwrite",isPrimary:!0}]});return s&&"Save and overwrite"===s.title?t():void 0};return(({ctrlKey:e,shiftKey:t,altKey:s,keys:n,callback:r})=>{const a=(0,i.useRef)([]),o=(0,i.useRef)(!1),l=(0,i.useRef)(!1),u=(0,i.useRef)(!1),d=(0,i.useRef)(null),c=(0,i.useRef)(r);c.current=r,(0,i.useEffect)((()=>{const i=i=>{if((i.ctrlKey||i.metaKey)&&(o.current=!0),i.shiftKey&&(l.current=!0),i.altKey&&(u.current=!0),!Z.has(i.key)&&Array.isArray(n)){const e=n.findIndex((e=>e.toLowerCase()===i.key.toLowerCase()));-1!==e&&(a.current[e]=i.key)}const r=!e||o.current,h=!t||l.current,p=!s||u.current;if(d.current=setTimeout((()=>{o.current=!1,l.current=!1,u.current=!1,a.current=[]}),250),r&&h&&p){if(Array.isArray(n)&&((e,t)=>{let s=0;for(const n of e){var i;if(n.toLowerCase()!==(null==(i=t[s])?void 0:i.toLowerCase()))return!1;s++}return!0})(n,a.current))return c.current();if(n===i.key)return c.current()}};return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i),d.current&&clearTimeout(d.current)}}),[e,t,s,n])})({ctrlKey:!0,keys:"s",callback:c}),(0,w.jsxs)(a.Z,{gap:"spacing-s",children:[(0,w.jsx)(R.Z,{type:"tertiary",icon:(0,w.jsx)(O.Z,{}),text:s?"Saving...":"Save",isDisabled:s||!n,onClick:c}),(0,w.jsx)(U.ShareButton,{entityType:"environment",entityId:o,entityName:l}),d?(0,w.jsx)($,{}):null]})})),z=r()(a.Z).withConfig({displayName:"tab-header__TabHeaderFlex",componentId:"sc-ahijuw-0"})(["box-sizing:border-box;gap:var(--spacing-s);padding:var(--spacing-s) var(--spacing-s);border-bottom:var(--border-width-default) var(--border-style-solid) var(--border-color-default);"]),q=()=>(0,w.jsxs)(z,{direction:"row",height:"48px",justifyContent:"space-between",children:[(0,w.jsx)(I,{}),(0,w.jsx)(W,{})]})},94720:(e,t,s)=>{s.d(t,{$F:()=>n,Bq:()=>i,XZ:()=>r});const i="Global variables for a workspace are a set of variables that are always available within the scope of that workspace. They can be viewed and edited by anyone in that workspace. ",n="https://go.pstmn.io/global-variable-docs",r={NOT_FOUND:404}},38357:(e,t,s)=>{s.d(t,{Z:()=>m}),s(40540);var i=s(50297),n=s(35736),r=s(21180),a=s(97482);var o=s(49437),l=s(63622);var u=s(52322);const d=({description:e})=>{const t=(0,a.hf)().errorState;if(t){const{title:e,description:s,Illustration:i}=t;return(0,u.jsx)(o.Z,{title:e,description:(0,u.jsx)(l.ZP,{type:"para",children:s}),children:(0,u.jsx)(i,{})})}return(0,u.jsx)(r.GenericErrorMessage,{title:"Something went wrong",description:e})},c=()=>{const e=(0,a.hf)();return[e.isDeleted,e.setIsDeleted.bind(e)]};var h=s(10099),p=s(34011);const m=(0,i.observer)((({children:e})=>{const t=(0,a.hf)().loadingText,{isLoading:s,isError:i,error:o}=(()=>{const e=(0,a.hf)();return{isLoading:e.isLoading,isError:e.isError,error:e.error,isReady:e.isReady}})(),[l]=c();return(()=>{const e=(0,p.Z)(),[,t]=c();(0,h.useWorkspaceSubscription)(e,(s=>{var i;const n=s.data;if("update_elements"===(null==(i=s.meta)?void 0:i.action))for(const s of n){const i=s.op,n=s.value,r=s.path;"remove"===i&&r.includes("/elements/environments")&&e===n&&t(!0)}}))})(),s?(0,u.jsx)(n.Z,{size:"large",description:t}):l?(0,u.jsx)(r.GenericErrorMessage,{title:"Coundn't find the environment",description:"It might have been moved or deleted.",illustration:"illustration-unable-to-load"}):i?(0,u.jsx)(d,{description:null==o?void 0:o.message}):(0,u.jsx)(u.Fragment,{children:e})}))},34011:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(97482);const n=()=>(0,i.hf)().id},51925:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(97482);const n=()=>(0,i.hf)().isDirty},9414:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(97482);const n=()=>(0,i.hf)().userPermissions},62356:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(97482);const n=()=>{const e=(0,i.hf)();return[e.values,e.updateValues]}},97482:(e,t,s)=>{s.d(t,{GF:()=>x,O4:()=>j,hf:()=>V});var i=s(40540),n=s.n(i),r=s(60607),a=s(78476),o=s(25202),l=s(97201),u=s(85692),d=s(98276);const c=e=>null!==e&&"object"==typeof e;function h(e,t){const s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(const i of s){const s=e[i],n=t[i],r=c(s)&&c(n);if(r&&!h(s,n)||!r&&s!==n)return!1}return!0}function p(e,t){return e.length===t.length&&e.every(((e,s)=>h(e,t[s])))}const m=["initialValues"];var v=s(94720);const b=Object.freeze({LOADING:0,ERROR:1,READY:2}),f=e=>e.map((e=>({key:e.key,value:e.value,enabled:e.enabled,type:e.type})));class g{get isLoading(){return this.status===b.LOADING||this.permissionsStatus===b.LOADING}get isError(){return this.status===b.ERROR}get isReady(){return this.status===b.READY}constructor(e,t){this.type="environment",this.loadingText="Loading Environment",this.isViewMoreActionsEnabled=!0,this.noVariablesEmptyState={header:"No variables in this environment",description:"Request additional access to this environment to add variables",showRequestAccess:!0},this.id=void 0,this.workspaceId=void 0,this.metadata={forkedFrom:null},this.error=null,this.status=void 0,this.permissionsStatus=void 0,this.editorState=null,this.updatesBuffer={},this.serverState=null,this.permissions={userCanCreate:!0,userCanUpdate:!0,userCanDelete:!0},this.unsubscribeFromPermissionsUpdates=null,this.unsubscribeFromUpdates=null,this.unsubscribeFromVariableSessionUpdates=null,this.isDeleted=!1,this.updateName=e=>{this.updatesBuffer.name=e},this.updateValues=e=>{if(!Array.isArray(e))throw new TypeError("Environment values must be an array");const{initialValues:t,sessionValues:s}=(0,d.unZipVariables)(e);this.updatesBuffer.initialValues=t,this.updatesBuffer.sessionValues=s},this.id=e,this.status=b.LOADING,this.permissionsStatus=b.LOADING,this.workspaceId=t,(0,a.makeObservable)(this,{status:!0,permissionsStatus:!0,editorState:!0,updatesBuffer:!0,serverState:!0,permissions:!0,metadata:!0,isDeleted:!0,name:a.computed,initialValues:a.computed,sessionValues:a.computed,values:a.computed,path:a.computed,isLoading:a.computed,isError:a.computed,isReady:a.computed,isDirty:a.computed,isConflicted:a.computed,userPermissions:a.computed,isForked:a.computed,forkLabel:a.computed,updateName:a.action,updateValues:a.action,persistUpdates:a.action,setIsDeleted:a.action}),this.init()}async init(){const e=new l.CacheObserver(l.cacheClient,(0,d.getEnvironmentItemQuery)(this.id));this.unsubscribeFromUpdates=e.subscribe((e=>this.onCacheUpdate(e))),this.onCacheUpdate(e.getCurrentResult()),this.unsubscribeFromVariableSessionUpdates=(0,u.subscribeToSession)({model:"environment",modelId:this.id},(e=>this.onVariableSessionCacheUpdate(e))),this.onVariableSessionCacheUpdate(await(0,u.getSession)({model:"environment",modelId:this.id}));const t=new l.CacheObserver(l.cacheClient,(0,d.getEnvironmentWorkbenchPermissionsQuery)(this.id,this.workspaceId));this.unsubscribeFromPermissionsUpdates=t.subscribe((e=>{this.onPermissionsCacheUpdate(e)})),this.onPermissionsCacheUpdate(t.getCurrentResult())}get userPermissions(){return this.permissions}get isConflicted(){return((e,t)=>{if(!e||!t)return!1;if(e===t)return!1;for(const s of m){let i;if("initialValues"!==s)throw new Error(`Unhandled 'key' for conflict detection ${s}`);if(i=p(e[s],t[s]),!i)return!0}return!1})(this.serverState,this.editorState)}get isForked(){var e;return Boolean(null==(e=this.metadata.forkedFrom)?void 0:e.forkName)}get forkLabel(){var e,t;return null!=(e=null==(t=this.metadata.forkedFrom)?void 0:t.forkName)?e:null}async onPermissionsCacheUpdate(e){const{data:t,error:s}=e,i=e=>{(0,a.runInAction)((()=>this.permissionsStatus=e))};return s?i(b.ERROR):t?void(0,a.runInAction)((()=>{t&&(this.permissions=Object.assign({},t)),this.permissionsStatus!==b.READY&&i(b.READY)})):i(b.LOADING)}async onCacheUpdate(e){const{data:t,error:s}=e,i=e=>(0,a.runInAction)((()=>this.status=e));if(s)return this.error=s,void i(b.ERROR);t?(0,a.runInAction)((()=>{var e,s;this.metadata.forkedFrom=t.forkedFrom,this.serverState={name:t.name,initialValues:t.values},this.isDirty||(this.editorState={name:t.name,initialValues:t.values,sessionValues:null!=(e=null==(s=this.editorState)?void 0:s.sessionValues)?e:[]}),this.status!==b.READY&&i(b.READY)})):i(b.LOADING)}async onVariableSessionCacheUpdate(e){e&&(0,a.runInAction)((()=>{var t;this.editorState||(this.editorState={name:"",initialValues:[],sessionValues:[]}),this.editorState.sessionValues=null!=(t=null==e?void 0:e.values)?t:[]}))}get name(){var e,t,s;return null!=(e=null!=(t=this.updatesBuffer.name)?t:null==(s=this.editorState)?void 0:s.name)?e:""}get initialValues(){var e,t,s;return null!=(e=null!=(t=this.updatesBuffer.initialValues)?t:null==(s=this.editorState)?void 0:s.initialValues)?e:[]}get sessionValues(){var e,t,s;return null!=(e=null!=(t=this.updatesBuffer.sessionValues)?t:null==(s=this.editorState)?void 0:s.sessionValues)?e:[]}get values(){const{initialValues:e,sessionValues:t}=this;return(0,d.zipVariables)(e,t)}get path(){return[{id:this.id,name:this.name}]}destroy(){var e,t,s;null==(e=this.unsubscribeFromUpdates)||e.call(this),null==(t=this.unsubscribeFromVariableSessionUpdates)||t.call(this),null==(s=this.unsubscribeFromPermissionsUpdates)||s.call(this)}get isDirty(){return Object.keys(this.updatesBuffer).length>0}getUpdates(){return(0,a.toJS)(Object.assign({},this.editorState,this.updatesBuffer))}persistUpdates(){this.editorState=Object.assign({},this.editorState,this.updatesBuffer),this.updatesBuffer={},this.serverState=this.editorState}getMutationData(){const e=this.getUpdates(),t=(e=>{const{values:t}=e;return Object.assign({},e,{values:f(t)})})({id:this.id,name:e.name,values:e.initialValues}),s=((e,t)=>Object.assign({},e,{values:e.values.map(((e,s)=>{var i;return null===e.value||void 0===e.value?Object.assign({},e,{value:null==(i=t.values[s])?void 0:i.value}):e}))}))({values:e.sessionValues},t);return{environment:t,session:s}}get saveMutationOptions(){const e=(0,d.updateEnvironmentWithSessionMutation)();return Object.assign({},e,{mutationFn:()=>{if(!this.isDirty)return Promise.reject(new Error("Nothing to update"));const{environment:t,session:s}=this.getMutationData();return this.persistUpdates(),e.mutationFn(t,s,!this.permissions.userCanUpdate)},onMutate:()=>{const e=(0,a.toJS)(this.editorState),t=(0,a.toJS)(this.updatesBuffer),s=(0,a.toJS)(this.serverState);return()=>{(0,a.runInAction)((()=>{this.editorState=e,this.updatesBuffer=t,this.serverState=s}))}},onSuccess:(...t)=>e.onSuccess(...t),onError:(e,t,s)=>{s()}})}get renameMutationOptions(){return(0,d.updateEnvironmentNameMutation)()}get errorState(){var e;return(null==(e=this.error)?void 0:e.statusCode)===v.XZ.NOT_FOUND?{title:"Environment not found",description:"We could not find the environment you are looking for",Illustration:o.Z}:null}setIsDeleted(e){this.isDeleted=e}}const y=["initialValues"],w=Object.freeze({LOADING:0,ERROR:1,READY:2}),S=e=>e.map((e=>({key:e.key,value:e.value,enabled:e.enabled,type:e.type})));class k{get isLoading(){return this.status===w.LOADING||this.permissionsStatus===w.LOADING}get isError(){return this.status===w.ERROR}get isReady(){return this.status===w.READY}constructor(e){this.id="",this.workspaceId=void 0,this.type="globals",this.name="Globals",this.loadingText="Loading Globals",this.isViewMoreActionsEnabled=!1,this.noVariablesEmptyState={header:"No global variables added",description:"",showRequestAccess:!1},this.isForked=!1,this.forkLabel=null,this.error=null,this.status=void 0,this.permissionsStatus=void 0,this.isDeleted=!1,this.editorState=null,this.updatesBuffer={},this.serverState=null,this.permissions={userCanCreate:!1,userCanUpdate:!0,userCanDelete:!1},this.unsubscribeFromPermissionsUpdates=null,this.unsubscribeFromUpdates=null,this.unsubscribeFromVariableSessionUpdates=null,this.updateName=()=>{throw new Error("Cannot update name for globals")},this.updateValues=e=>{if(!Array.isArray(e))throw new TypeError("Global values must be an array");const{initialValues:t,sessionValues:s}=(0,d.unZipVariables)(e);this.updatesBuffer.initialValues=t,this.updatesBuffer.sessionValues=s},this.status=w.LOADING,this.permissionsStatus=w.LOADING,this.workspaceId=e,(0,a.makeObservable)(this,{status:!0,permissionsStatus:!0,editorState:!0,updatesBuffer:!0,serverState:!0,permissions:!0,values:a.computed,path:a.computed,isLoading:a.computed,isError:a.computed,isReady:a.computed,isDirty:a.computed,isConflicted:a.computed,userPermissions:a.computed,updateName:a.action,updateValues:a.action,persistUpdates:a.action}),this.init(e)}async init(e){const t=new l.CacheObserver(l.cacheClient,(0,d.getGlobalsItemQuery)(e));this.unsubscribeFromUpdates=t.subscribe((e=>this.onCacheUpdate(e))),this.onCacheUpdate(t.getCurrentResult());const s=new l.CacheObserver(l.cacheClient,(0,d.getGlobalsWorkbenchPermissionsQuery)(e));this.unsubscribeFromPermissionsUpdates=s.subscribe((e=>{this.onPermissionsCacheUpdate(e)})),this.onPermissionsCacheUpdate(s.getCurrentResult())}async onPermissionsCacheUpdate(e){const{data:t,error:s}=e,i=e=>{(0,a.runInAction)((()=>this.permissionsStatus=e))};return s?i(w.ERROR):t?void(0,a.runInAction)((()=>{(0,a.runInAction)((()=>{this.permissions=Object.assign({},this.permissions,{userCanUpdate:t.userCanUpdate})})),this.permissionsStatus!==w.READY&&i(w.READY)})):i(w.LOADING)}get userPermissions(){return this.permissions}async onCacheUpdate(e){const{data:t,error:s}=e,i=e=>(0,a.runInAction)((()=>this.status=e));if(s)return this.error=s,void i(w.ERROR);t?((0,a.runInAction)((()=>{var e,s;!this.id&&(this.id=t.id),this.serverState={initialValues:t.values},this.isDirty||(this.editorState={initialValues:t.values,sessionValues:null!=(e=null==(s=this.editorState)?void 0:s.sessionValues)?e:[]})})),this.status!==w.READY&&(this.unsubscribeFromVariableSessionUpdates=(0,u.subscribeToSession)({model:"globals",modelId:this.id},(e=>this.onVariableSessionCacheUpdate(e))),(0,u.getSession)({model:"globals",modelId:this.id}).then((e=>{this.onVariableSessionCacheUpdate(e),i(w.READY)})).catch((e=>{i(w.ERROR),this.error=e})))):i(w.LOADING)}async onVariableSessionCacheUpdate(e){e&&(0,a.runInAction)((()=>{var t;this.editorState||(this.editorState={initialValues:[],sessionValues:[]}),this.editorState.sessionValues=null!=(t=null==e?void 0:e.values)?t:[]}))}get initialValues(){var e,t,s;return null!=(e=null!=(t=this.updatesBuffer.initialValues)?t:null==(s=this.editorState)?void 0:s.initialValues)?e:[]}get sessionValues(){var e,t,s;return null!=(e=null!=(t=this.updatesBuffer.sessionValues)?t:null==(s=this.editorState)?void 0:s.sessionValues)?e:[]}get values(){const{initialValues:e,sessionValues:t}=this;return(0,d.zipVariables)(e,t)}get path(){return[{id:this.id,name:this.name}]}destroy(){var e,t,s;null==(e=this.unsubscribeFromUpdates)||e.call(this),null==(t=this.unsubscribeFromVariableSessionUpdates)||t.call(this),null==(s=this.unsubscribeFromPermissionsUpdates)||s.call(this)}get isDirty(){return Object.keys(this.updatesBuffer).length>0}getUpdates(){return(0,a.toJS)(Object.assign({},this.editorState,this.updatesBuffer,{name:this.name,id:this.id}))}persistUpdates(){this.editorState=Object.assign({},this.editorState,this.updatesBuffer),this.updatesBuffer={},this.serverState=this.editorState}getMutationData(){const e=this.getUpdates(),t=(e=>{const{values:t}=e;return Object.assign({},e,{values:S(t)})})({values:e.initialValues}),s=((e,t)=>Object.assign({},e,{values:e.values.map(((e,s)=>{var i;return null===e.value||void 0===e.value?Object.assign({},e,{value:null==(i=t.values[s])?void 0:i.value}):e}))}))({values:e.sessionValues},t);return{globals:{id:this.id,values:t.values,workspace:this.workspaceId},session:s}}get isConflicted(){return((e,t)=>{if(!e||!t)return!1;if(e===t)return!1;for(const s of y){let i;if("initialValues"!==s)throw new Error(`Unhandled 'key' for conflict detection ${s}`);if(i=p(e[s],t[s]),!i)return!0}return!1})(this.serverState,this.editorState)}get saveMutationOptions(){const e=(0,d.updateGlobalsWithSessionMutation)();return Object.assign({},e,{mutationFn:()=>{if(!this.isDirty)return Promise.reject(new Error("Nothing to update"));const{globals:t,session:s}=this.getMutationData();return this.persistUpdates(),e.mutationFn(t,s,!this.permissions.userCanUpdate)},onMutate:()=>{const e=(0,a.toJS)(this.editorState),t=(0,a.toJS)(this.updatesBuffer),s=(0,a.toJS)(this.serverState);return()=>{(0,a.runInAction)((()=>{this.editorState=e,this.updatesBuffer=t,this.serverState=s}))}},onSuccess:(...t)=>{e.onSuccess(...t)},onError:(e,t,s)=>{s()}})}get renameMutationOptions(){return null}get errorState(){var e;return(null==(e=this.error)?void 0:e.statusCode)===v.XZ.NOT_FOUND?{title:"Globals not found",description:"We could not find the globals you are looking for",Illustration:o.Z}:null}setIsDeleted(){}}var C=s(52322);const E=n().createContext(void 0),x=({children:e})=>{if(!(0,r.useInRouterContext)())throw new Error("EnvironmentEditorProvider must be used within a router context");const{environmentId:t,workspaceId:s}=(0,r.useParams)();if(!t)throw new Error("Environment ID not found");if(!s)throw new Error("workspace ID not found");(0,d.useEnvironmentSubscription)(t);const n=(0,i.useMemo)((()=>new g(t,s)),[]);return(0,i.useEffect)((()=>()=>n.destroy()),[]),(0,C.jsx)(E.Provider,{value:n,children:e})},j=({children:e})=>{if(!(0,r.useInRouterContext)())throw new Error("GlobalsEditorProvider must be used within a router context");const{workspaceId:t}=(0,r.useParams)();if(!t)throw new Error("workspace ID not found");const s=(0,i.useMemo)((()=>new k(t)),[]);return(0,i.useEffect)((()=>()=>s.destroy()),[]),(0,C.jsx)(E.Provider,{value:s,children:e})},V=()=>{const e=n().useContext(E);if(!e)throw new Error("useEnvironmentEditorStore must be used within a EnvironmentEditorProvider");return e}}}]);
//# sourceMappingURL=8351.8358b72e70f36870.js.map